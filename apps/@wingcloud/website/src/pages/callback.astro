---
import Layout from "../components/Layout.astro";
import { getOrCreateUser } from "../database/user.js";
import { setAuthorizationCookie } from "../utils/authorization.js";
import { getGitHubLoginFromCode } from "../utils/github.js";

const code = Astro.url.searchParams.get("code");
if (code) {
  const { login, tokens } = await getGitHubLoginFromCode(code);

  const userId = await getOrCreateUser(login);

  setAuthorizationCookie(userId, tokens, Astro.cookies);

  return Astro.redirect("/dashboard");
}
---

<Layout title="Something went wrong">
  <p>The code query param is missing</p>
</Layout>
